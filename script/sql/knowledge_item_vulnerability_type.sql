-- ----------------------------
-- 知识条目漏洞类型关联表
-- 支持一个知识条目对应多个漏洞类型（CWE）
-- 创建日期: 2026-01-15
-- ----------------------------

SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- ----------------------------
-- 新建表：knowledge_item_vulnerability_type（知识条目漏洞类型关联表）
-- ----------------------------
DROP TABLE IF EXISTS `knowledge_item_vulnerability_type`;
CREATE TABLE `knowledge_item_vulnerability_type`
(
    `id`                   bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `item_uuid`            varchar(64) NOT NULL COMMENT '知识条目UUID（关联 knowledge_item.item_uuid）',
    `cwe_id`               varchar(20) NOT NULL COMMENT 'CWE编号（关联 cwe_reference.cwe_id，如 CWE-89）',
    
    -- RuoYi 标准字段
    `create_time`          datetime NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `tenant_id`            bigint(20) NOT NULL DEFAULT 0 COMMENT '租户ID',
    
    PRIMARY KEY (`id`) USING BTREE,
    UNIQUE INDEX `uk_item_cwe`(`item_uuid`, `cwe_id`) USING BTREE,
    INDEX `idx_item_uuid`(`item_uuid`) USING BTREE,
    INDEX `idx_cwe_id`(`cwe_id`) USING BTREE,
    CONSTRAINT `fk_knowledge_item_vuln_item` FOREIGN KEY (`item_uuid`) REFERENCES `knowledge_item` (`item_uuid`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE = InnoDB CHARACTER SET = utf8mb4 COLLATE = utf8mb4_general_ci COMMENT = '知识条目漏洞类型关联表（支持多选）' ROW_FORMAT = DYNAMIC;

-- ----------------------------
-- 说明：
-- 1. 此表支持一个知识条目对应多个漏洞类型（CWE）
-- 2. 关联字段使用 cwe_id（如 CWE-89），而非 cwe_reference 表的主键 id
-- 3. 保留 knowledge_item.vulnerability_type 字段作为冗余字段（主类型，用于快速查询和兼容）
-- 4. 外键约束仅关联 knowledge_item，不关联 cwe_reference（因为 cwe_reference 可能没有外键约束）
-- ----------------------------

SET FOREIGN_KEY_CHECKS = 1;
