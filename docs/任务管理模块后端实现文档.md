# 任务管理模块后端实现文档

## 概述
本文档描述了任务管理模块的后端实现，所有类名均使用 `TaskManagement` 前缀以避免命名冲突。

## 数据库设计

### 表结构
1. **task_management** - 任务管理主表
2. **task_management_file** - 任务文件表
3. **task_management_tag** - 任务标签关联表

详细SQL脚本位置：`script/sql/task_management.sql`

## 代码结构

### 1. 实体类 (Domain)
位置：`ruoyi-modules/ruoyi-chat/src/main/java/org/ruoyi/chat/domain/`

- **TaskManagement.java** - 任务管理实体类
  - 继承 BaseEntity，包含基础字段
  - 包含 inputFiles、outputFiles、tags 等关联属性（不映射到数据库）

- **TaskManagementFile.java** - 任务文件实体类
  - 包含文件基本信息和文件类别（input/output）

- **TaskManagementTag.java** - 任务标签实体类
  - 任务与标签的多对多关联

### 2. VO对象 (View Object)
位置：`ruoyi-modules/ruoyi-chat/src/main/java/org/ruoyi/chat/domain/vo/`

- **TaskManagementVo.java** - 任务管理视图对象
  - 用于返回给前端的数据格式
  - 将 createTime/updateTime 映射为 createdAt/updatedAt

- **TaskManagementFileVo.java** - 文件视图对象
  - 简化的文件信息

### 3. Mapper接口
位置：`ruoyi-modules/ruoyi-chat/src/main/java/org/ruoyi/chat/mapper/`

- **TaskManagementMapper.java** - 任务管理数据访问接口
- **TaskManagementFileMapper.java** - 文件数据访问接口
- **TaskManagementTagMapper.java** - 标签数据访问接口

### 4. Mapper XML
位置：`ruoyi-modules-api/ruoyi-chat-api/src/main/resources/mapper/`

- **TaskManagementMapper.xml** - 任务管理SQL映射
- **TaskManagementFileMapper.xml** - 文件SQL映射
- **TaskManagementTagMapper.xml** - 标签SQL映射

### 5. Service接口和实现
位置：`ruoyi-modules/ruoyi-chat/src/main/java/org/ruoyi/chat/service/`

#### 接口
- **ITaskManagementService.java** - 任务管理服务接口
- **ITaskManagementFileService.java** - 文件管理服务接口

#### 实现类
位置：`ruoyi-modules/ruoyi-chat/src/main/java/org/ruoyi/chat/service/impl/`

- **TaskManagementServiceImpl.java** - 任务管理服务实现
  - 创建任务（支持事务，同时保存标签和关联文件）
  - 分页查询任务列表
  - 查询任务详情（包含文件和标签）
  - 更新任务（支持标签更新）
  - 删除任务（逻辑删除）

- **TaskManagementFileServiceImpl.java** - 文件管理服务实现
  - 文件上传（使用OSS存储）
  - 文件下载
  - 根据任务ID查询文件列表

### 6. Controller
位置：`ruoyi-modules/ruoyi-chat/src/main/java/org/ruoyi/chat/controller/`

- **TaskManagementController.java** - 任务管理控制器

#### API接口列表

| 接口路径 | 方法 | 说明 |
|---------|------|------|
| /task/create | POST | 创建任务 |
| /task/list | GET | 查询任务列表（分页） |
| /task/detail/{id} | GET | 获取任务详情 |
| /task/update/{id} | PUT | 更新任务 |
| /task/delete/{id} | DELETE | 删除任务 |
| /task/file/upload | POST | 上传文件 |
| /task/file/download/{fileId} | GET | 下载文件 |

## API接口详细说明

### 1. 创建任务
**接口地址：** `POST /task/create`

**请求参数：**
```json
{
  "title": "任务标题",
  "description": "任务描述",
  "priority": "low|medium|high|urgent",
  "taskType": "code_standard_check|data_security_audit|dependency_analysis|compliance_audit|other",
  "tags": ["标签1", "标签2"],
  "inputFiles": [
    {
      "id": "文件ID"
    }
  ]
}
```

**响应结果：**
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": 任务ID
}
```

### 2. 查询任务列表
**接口地址：** `GET /task/list`

**请求参数：**
- currentPage: 当前页码（默认1）
- pageSize: 每页大小（默认10）
- status: 任务状态（可选）
- priority: 任务优先级（可选）
- taskType: 任务类型（可选）

**响应结果：**
```json
{
  "code": 200,
  "msg": "查询成功",
  "total": 100,
  "rows": [
    {
      "id": 1,
      "title": "任务标题",
      "description": "任务描述",
      "priority": "medium",
      "taskType": "code_standard_check",
      "status": "pending",
      "inputFiles": [...],
      "outputFiles": [...],
      "tags": ["标签1", "标签2"],
      "createdAt": "2024-01-01 12:00:00",
      "updatedAt": "2024-01-01 12:00:00"
    }
  ]
}
```

### 3. 获取任务详情
**接口地址：** `GET /task/detail/{id}`

**响应结果：** 同上单个任务对象

### 4. 更新任务
**接口地址：** `PUT /task/update/{id}`

**请求参数：** 同创建任务，但所有字段可选

### 5. 删除任务
**接口地址：** `DELETE /task/delete/{id}`

**响应结果：**
```json
{
  "code": 200,
  "msg": "操作成功"
}
```

### 6. 上传文件
**接口地址：** `POST /task/file/upload`

**请求参数：**
- file: 文件（multipart/form-data）
- taskId: 任务ID（可选，如果在创建任务前上传可不传）

**响应结果：**
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    "id": "文件ID",
    "name": "文件名",
    "url": "文件URL",
    "size": 文件大小,
    "type": "文件类型",
    "uploadTime": "上传时间"
  }
}
```

### 7. 下载文件
**接口地址：** `GET /task/file/download/{fileId}`

**响应：** 文件流

## 核心功能说明

### 1. 任务创建流程
1. 前端先上传文件，获取文件ID
2. 创建任务时传入文件ID列表
3. 后端在事务中：
   - 插入任务记录
   - 批量插入标签
   - 更新文件的taskId字段

### 2. 文件管理
- 使用OSS存储服务（支持多种云存储）
- 文件分为输入文件（input）和输出文件（output）
- 支持文件上传、下载、列表查询

### 3. 标签管理
- 支持任务标签的添加、更新、删除
- 标签与任务是多对多关系
- 更新任务时会删除旧标签并插入新标签

### 4. 分页查询
- 使用MyBatis-Plus的Page对象
- 支持按状态、优先级、任务类型过滤
- 自动加载关联的文件和标签

### 5. 逻辑删除
- 任务和文件都使用逻辑删除（del_flag字段）
- 删除任务时不会物理删除数据

## 数据库字段说明

### TaskManagement表主要字段
- id: 主键
- title: 任务标题
- description: 任务描述
- priority: 优先级（low/medium/high/urgent）
- task_type: 任务类型
- status: 状态（pending/in_progress/completed/cancelled）
- del_flag: 删除标志
- tenant_id: 租户ID（支持多租户）

### TaskManagementFile表主要字段
- id: 主键
- task_id: 任务ID
- name: 文件名
- url: 文件URL
- size: 文件大小
- type: 文件类型
- file_category: 文件类别（input/output）
- upload_time: 上传时间

### TaskManagementTag表主要字段
- id: 主键
- task_id: 任务ID
- tag_name: 标签名称
- create_time: 创建时间

## 注意事项

1. **表名一致性**：数据库SQL中的表名已统一修改为 `task_management`、`task_management_file`、`task_management_tag`

2. **类名统一**：所有Java类名都使用 `TaskManagement` 前缀

3. **事务管理**：创建和更新任务使用 `@Transactional` 注解确保数据一致性

4. **文件存储**：文件上传依赖 `ruoyi-common-oss` 模块，需配置OSS相关参数

5. **权限控制**：如需添加权限控制，可在Controller方法上添加 `@SaCheckPermission` 注解

6. **多租户支持**：实体类包含 `tenant_id` 字段，支持多租户隔离

7. **前端对接**：前端接口定义中的字段名与后端VO对象一致，可直接对接

## 部署步骤

1. 执行数据库脚本：`script/sql/task_management.sql`
2. 确保OSS配置正确（application.yml中的oss配置）
3. 重启应用
4. 前端可以开始调用接口

## 扩展建议

1. 可以添加任务执行的异步处理功能
2. 可以添加任务进度跟踪
3. 可以添加任务分配功能（分配给用户）
4. 可以添加任务评论功能
5. 可以添加任务日志记录







